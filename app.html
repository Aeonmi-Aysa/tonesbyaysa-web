<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tones by Aysa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Core styles: use inline styles only plus styles.css if present -->
  <link rel="stylesheet" href="css/styles.css" />

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/_config.js" defer></script>

  <!-- Favorites Manager -->
  <script src="js/favorites-manager.js"></script>

  <script>
  // Global favorites manager
  let favoritesManager;

  async function initFavorites() {
    const SUPABASE_URL = window.ENV?.SUPABASE_URL || 'https://your-project.supabase.co';const SUPABASE_ANON_KEY = window.ENV?.SUPABASE_ANON_KEY || '';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    favoritesManager = new FavoritesManager(supabase);
    await favoritesManager.init();
    updateFavoriteButtons();
  }

  async function toggleFavorite(itemId, itemType) {
    if (!favoritesManager) await initFavorites();
    const isFavorite = await favoritesManager.toggleFavorite(itemId, itemType);
    
    const btn = document.querySelector(`[data-fav-id="${itemId}"]`);
    if (btn) {
      btn.classList.toggle('favorited', isFavorite);
      btn.innerHTML = isFavorite ? 'üíú' : 'ü§ç';
    }
  }

  function updateFavoriteButtons() {
    document.querySelectorAll('[data-fav-id]').forEach(btn => {
      const itemId = btn.dataset.favId;
      const isFav = favoritesManager?.isFavorite(itemId);
      btn.classList.toggle('favorited', isFav);
      btn.innerHTML = isFav ? 'üíú' : 'ü§ç';
    });
  }

  document.addEventListener('DOMContentLoaded', initFavorites);
  </script>

  <!-- Tone.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

  <!-- Frequency Data -->
  <script src="data/frequency-catalog.js"></script>
  <script src="data/frequency-baths.js"></script>
  <script src="data/smart-stacks.js"></script>
  <script src="js/frequency-data-loader.js"></script>

  <!-- Unlock WebAudio on first gesture (Tone + custom player) -->
  <script>
    window.addEventListener(
      "pointerdown",
      async () => {
        try {
          if (window.Tone?.start) await window.Tone.start();
          if (window.frequencyPlayer?.init) await window.frequencyPlayer.init();
        } catch (err) {
          console.warn("Audio unlock failed; will retry on play", err);
        }
      },
      { once: true }
    );
  </script>

  <style>
    :root {
      --bg-primary: #0a0a14;
      --bg-secondary: #111827;
      --bg-elevated: #020617;
      --text-primary: #e5e7eb;
      --text-secondary: #9ca3af;
      --border-color: rgba(148, 163, 184, 0.4);
      --accent: #fbbf24;
      --accent-soft: rgba(251, 191, 36, 0.1);
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.1);
      --success: #4ade80;
      --success-soft: rgba(74, 222, 128, 0.1);
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
    }

    body.light-mode {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-elevated: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --border-color: rgba(100, 116, 139, 0.35);
      --accent: #9333ea;
      --accent-soft: rgba(147, 51, 234, 0.1);
      --danger: #dc2626;
      --danger-soft: rgba(220, 38, 38, 0.1);
      --success: #059669;
      --success-soft: rgba(5, 150, 105, 0.12);
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(ellipse at top left, rgba(139, 92, 246, 0.08) 0%, transparent 40%), 
                  radial-gradient(ellipse at bottom right, rgba(251, 191, 36, 0.06) 0%, transparent 40%),
                  linear-gradient(180deg, #0a0a14 0%, #0f0f1f 50%, #0a0a14 100%);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    body.light-mode {
      background: linear-gradient(180deg, #ffffff 0%, #f8fafb 50%, #f1f5f9 100%);
    }

    .app-root {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
      width: 100%;
      box-sizing: border-box;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left,
          rgba(251, 191, 36, 0.16) 0,
          rgba(15, 23, 42, 0.98) 40%,
          rgba(15, 23, 42, 1) 100%);
      border: 1px solid rgba(251, 191, 36, 0.3);
      box-shadow:
        0 10px 40px rgba(15, 23, 42, 0.9),
        0 0 60px rgba(251, 191, 36, 0.18);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    body.light-mode header {
      background: linear-gradient(135deg, rgba(147, 51, 234, 0.06) 0%, rgba(248, 250, 252, 1) 100%);
      border: 1px solid rgba(147, 51, 234, 0.15);
      box-shadow: 0 8px 32px rgba(147, 51, 234, 0.08);
    }

    .logo-block {
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
      z-index: 1;
    }

    .logo-mark {
      width: 52px;
      height: 52px;
      border-radius: 999px;
      border: 1px solid rgba(251, 191, 36, 0.5);
      display: grid;
      place-items: center;
      background: radial-gradient(circle at 25% 0,
          rgba(251, 191, 36, 0.6),
          rgba(15, 23, 42, 1));
      box-shadow: 0 0 24px rgba(251, 191, 36, 0.5);
    }

    .logo-mark-inner {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid rgba(251, 191, 36, 0.5);
      background: conic-gradient(
          from 0deg,
          rgba(251, 191, 36, 0.01),
          rgba(251, 191, 36, 0.8),
          rgba(251, 191, 36, 0.01)
        );
      display: grid;
      place-items: center;
      position: relative;
      overflow: hidden;
    }

    .logo-mark-inner::after {
      content: "";
      position: absolute;
      inset: 8px;
      border-radius: inherit;
      background: radial-gradient(circle,
          rgba(15, 23, 42, 1) 0,
          rgba(15, 23, 42, 0.8) 60%,
          rgba(15, 23, 42, 0) 100%);
    }

    .logo-wave {
      width: 22px;
      height: 22px;
      position: relative;
    }

    .logo-wave svg {
      width: 100%;
      height: 100%;
    }

    .logo-text-block {
      display: flex;
      flex-direction: column;
      line-height: 1.3;
    }

    .logo-text-sub {
      font-size: 0.7rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: rgba(251, 191, 36, 0.85);
    }

    .logo-text-main {
      font-size: 1.6rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-primary);
      font-weight: 500;
    }

    .logo-text-tagline {
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.9);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 1;
    }

    .theme-toggle {
      background: none;
      border-radius: 999px;
      width: 40px;
      height: 40px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      display: grid;
      place-items: center;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .theme-toggle:hover {
      border-color: var(--accent);
      background: rgba(251, 191, 36, 0.12);
      box-shadow: 0 0 12px rgba(251, 191, 36, 0.3);
    }

    .user-pill {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.3rem 0.85rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.45);
      backdrop-filter: blur(16px);
      font-size: 0.8rem;
    }

    .user-pill span {
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .signout-btn {
      border: none;
      border-radius: 999px;
      padding: 0.3rem 0.7rem;
      background: rgba(248, 113, 113, 0.1);
      color: #fecaca;
      cursor: pointer;
      font-size: 0.75rem;
      display: none;
      align-items: center;
      gap: 0.25rem;
      transition: all 0.2s ease;
    }

    .signout-btn.visible {
      display: inline-flex;
    }

    .signout-btn:hover {
      background: rgba(248, 113, 113, 0.25);
      box-shadow: 0 0 12px rgba(248, 113, 113, 0.3);
    }

    .stats-grid {
      margin-top: 1.5rem;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.85rem;
    }

    .stat-card {
      background: linear-gradient(135deg,
          rgba(15, 23, 42, 0.96),
          rgba(15, 23, 42, 0.9));
      border-radius: var(--radius-md);
      padding: 0.7rem 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .stat-value {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-secondary);
    }

    .tabs {
      margin-top: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
    }

    .tab {
      padding: 0.55rem 0.9rem;
      border-radius: 999px 999px 0 0;
      cursor: pointer;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: 1px solid transparent;
      color: var(--text-secondary);
      background: transparent;
      position: relative;
      top: 1px;
    }

    .tab.active {
      background: var(--bg-elevated);
      border-color: rgba(148, 163, 184, 0.5);
      border-bottom-color: var(--bg-elevated);
      color: var(--accent);
    }

    .tab-content {
      margin-top: 1rem;
      padding: 1.25rem 1.25rem 1.8rem;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      background: var(--bg-elevated);
      border: 1px solid rgba(148, 163, 184, 0.3);
      min-height: 320px;
    }

    h2.section-title {
      text-align: center;
      margin-top: 0.5rem;
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .tier-notice {
      margin: 0 auto 1rem;
      padding: 0.85rem 1rem;
      border-radius: var(--radius-md);
      border: 1px solid rgba(248, 113, 113, 0.6);
      background: rgba(248, 113, 113, 0.12);
      color: var(--text-primary);
      font-size: 0.9rem;
      max-width: 800px;
      text-align: center;
    }

    .frequencies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1.1rem;
    }

    .frequency-card {
      background: linear-gradient(135deg,
          rgba(15, 23, 42, 0.96),
          rgba(30, 64, 175, 0.88));
      border-radius: var(--radius-md);
      padding: 0.9rem 1rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.8);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .frequency-card.is-favorite {
      border-color: rgba(251, 191, 36, 0.9);
      box-shadow: 0 0 18px rgba(251, 191, 36, 0.45);
    }

    .frequency-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .frequency-name {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .frequency-tag {
      font-size: 0.75rem;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--text-secondary);
    }

    .favorite-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      color: rgba(251, 191, 36, 0.25);
      transition: transform 0.18s ease, color 0.18s ease;
    }

    .favorite-btn.active {
      color: rgba(251, 191, 36, 0.95);
      transform: scale(1.05);
    }

    .frequency-main {
      padding: 0.55rem 0.65rem;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: radial-gradient(circle at top,
          rgba(251, 191, 36, 0.08),
          rgba(15, 23, 42, 1));
    }

    .frequency-main-value {
      font-size: 1.55rem;
      font-weight: 700;
      color: var(--accent);
    }

    .frequency-main-unit {
      font-size: 0.78rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .frequency-usage {
      font-size: 0.82rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .frequency-actions {
      margin-top: 0.5rem;
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      padding: 0.6rem 0.85rem;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-primary);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      min-width: 0;
      flex: 1 1 auto;
    }

    .btn-primary {
      border-color: rgba(251, 191, 36, 0.9);
      background: rgba(251, 191, 36, 0.16);
      color: var(--accent);
    }

    .btn-primary:hover {
      background: rgba(251, 191, 36, 0.26);
    }

    .btn-danger {
      border-color: rgba(248, 113, 113, 0.9);
      background: rgba(248, 113, 113, 0.18);
      color: #fecaca;
    }

    .btn-danger:hover {
      background: rgba(248, 113, 113, 0.28);
    }

    .btn-outline {
      background: transparent;
    }

    .btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .category-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      justify-content: center;
      margin-bottom: 0.8rem;
    }

    .chip {
      border-radius: 999px;
      padding: 0.2rem 0.9rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }

    .chip.active {
      border-color: rgba(251, 191, 36, 0.9);
      background: rgba(251, 191, 36, 0.2);
      color: var(--accent);
    }

    .subtle-pill {
      margin: 0.5rem auto 1.25rem;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.8);
      font-size: 0.78rem;
      text-align: center;
      max-width: 280px;
    }

    .two-column {
      display: grid;
      grid-template-columns: 2fr 1.3fr;
      gap: 1.2rem;
    }

    .panel {
      border-radius: var(--radius-md);
      padding: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.96);
    }

    .panel-title {
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      margin-bottom: 0.8rem;
      color: var(--text-secondary);
    }

    .input,
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 0.6rem 0.7rem;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-primary);
      font-size: 0.85rem;
      font-family: inherit;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .journal-entry {
      border-radius: var(--radius-md);
      padding: 0.7rem 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      font-size: 0.85rem;
    }

    .journal-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 0.1rem 0.5rem;
      font-size: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--text-secondary);
    }

    .badge-success {
      border-color: rgba(74, 222, 128, 0.8);
      color: #bbf7d0;
    }

    .badge-soft {
      border-style: dashed;
    }

    .dial-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .dial-circle {
      width: 260px;
      height: 260px;
      border-radius: 999px;
      border: 1px solid rgba(251, 191, 36, 0.5);
      background: radial-gradient(circle,
          rgba(251, 191, 36, 0.07),
          rgba(15, 23, 42, 1));
      position: relative;
      box-shadow:
        0 0 32px rgba(251, 191, 36, 0.35),
        inset 0 0 36px rgba(0, 0, 0, 0.8);
      overflow: hidden;
    }

    .dial-needle {
      position: absolute;
      width: 3px;
      height: 40%;
      background: linear-gradient(to bottom,
          rgba(251, 191, 36, 0.1),
          rgba(251, 191, 36, 0.9));
      left: 50%;
      bottom: 50%;
      transform-origin: bottom center;
      transform: rotate(0deg);
      border-radius: 999px;
      box-shadow: 0 0 10px rgba(251, 191, 36, 0.6);
    }

    .dial-center {
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 1);
      border: 2px solid rgba(251, 191, 36, 0.9);
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 10px rgba(251, 191, 36, 0.9);
    }

    .dial-scale-label {
      position: absolute;
      font-size: 0.65rem;
      color: rgba(148, 163, 184, 0.9);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .dial-label-bottom {
      left: 50%;
      bottom: 0.4rem;
      transform: translateX(-50%);
    }

    .dial-label-top {
      left: 50%;
      top: 0.4rem;
      transform: translateX(-50%);
    }

    .dial-label-left {
      left: 0.4rem;
      top: 50%;
      transform: translateY(-50%);
    }

    .dial-label-right {
      right: 0.4rem;
      top: 50%;
      transform: translateY(-50%);
    }

    .dial-readout {
      text-align: center;
      padding: 0.7rem 0.8rem;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      min-width: 220px;
    }

    .dial-readout-main {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, "Roboto Mono",
        monospace;
      font-size: 1.7rem;
      font-weight: 700;
      color: var(--accent);
    }

    .dial-readout-unit {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .dial-slider-wrap {
      width: 100%;
      max-width: 340px;
    }

    .dial-slider {
      width: 100%;
    }

    .preset-grid {
      margin-top: 0.8rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
      gap: 0.4rem;
    }

    .preset-btn {
      border-radius: 999px;
      padding: 0.35rem 0.6rem;
      font-size: 0.78rem;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-secondary);
      cursor: pointer;
      text-align: center;
      transition: all 0.18s ease;
    }

    .preset-btn.active,
    .preset-btn:hover {
      border-color: rgba(251, 191, 36, 0.9);
      background: rgba(251, 191, 36, 0.14);
      color: var(--accent);
    }

    .dial-mode-toggle {
      margin-top: 0.8rem;
      display: flex;
      gap: 0.4rem;
      justify-content: center;
    }

    .mode-btn {
      padding: 0.3rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      background: rgba(15, 23, 42, 0.9);
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      cursor: pointer;
      color: var(--text-secondary);
    }

    .mode-btn.active {
      border-color: rgba(251, 191, 36, 0.9);
      background: rgba(251, 191, 36, 0.18);
      color: var(--accent);
    }

    .small-muted {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .composer-stack {
      min-height: 120px;
      border-radius: var(--radius-md);
      border: 1px dashed rgba(148, 163, 184, 0.7);
      padding: 0.7rem;
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .composer-layer {
      padding: 0.4rem 0.55rem;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 0.85rem;
    }

    .tag {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
    }

    .settings-item {
      border-radius: var(--radius-md);
      padding: 0.9rem 1rem;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.96);
      font-size: 0.88rem;
    }

    .settings-item h3 {
      margin-top: 0;
      margin-bottom: 0.4rem;
      font-size: 0.95rem;
    }

    .settings-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    @media (max-width: 900px) {
      .two-column {
        grid-template-columns: minmax(0, 1fr);
      }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }

      .header-right {
        align-self: stretch;
        justify-content: space-between;
      }

      .stats-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .stats-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .tabs {
        overflow-x: auto;
        padding-bottom: 0.4rem;
      }

      .tab {
        white-space: nowrap;
      }
    }
    .favorite-btn {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  background: rgba(0, 0, 0, 0.5);
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.5rem;
  transition: all 0.3s ease;
  z-index: 10;
  padding: 0;
}

.favorite-btn:hover {
  transform: scale(1.1);
  background: rgba(0, 0, 0, 0.7);
}

.favorite-btn.favorited {
  background: linear-gradient(135deg, #be185d, #a855f7);
  border-color: #be185d;
  box-shadow: 0 0 20px rgba(190, 24, 93, 0.5);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 20px rgba(190, 24, 93, 0.5); }
  50% { box-shadow: 0 0 30px rgba(190, 24, 93, 0.8); }
}

.frequency-card,
.bath-card {
  position: relative; /* Required for absolute positioning of favorite button */
}
  </style>
</head>
<body>
  <div class="app-root">
    <header>
      <div class="logo-block">
        <div class="logo-mark">
          <div class="logo-mark-inner">
            <div class="logo-wave">
              <svg viewBox="0 0 64 64">
                <defs>
                  <linearGradient id="waveGrad" x1="0" y1="0" x2="1" y2="0">
                    <stop offset="0%" stop-color="#fbbf24" stop-opacity="0.5"></stop>
                    <stop offset="40%" stop-color="#fbbf24"></stop>
                    <stop offset="100%" stop-color="#fde68a" stop-opacity="0.7"></stop>
                  </linearGradient>
                </defs>
                <path
                  d="M2 32 Q10 14 18 32 T34 32 T50 32 T62 32"
                  fill="none"
                  stroke="url(#waveGrad)"
                  stroke-width="4"
                  stroke-linecap="round"
                />
              </svg>
            </div>
          </div>
        </div>
        <div class="logo-text-block">
          <div class="logo-text-sub">Healing Frequency Studio</div>
          <div class="logo-text-main">TONES BY AYSA</div>
          <div class="logo-text-tagline">Tune your inner resonance</div>
        </div>
      </div>
      <div class="header-right">
        <button id="themeToggle" class="theme-toggle" title="Toggle dark/light">
          ‚òæ
        </button>
        <div class="user-pill">
          <span id="userName">Guest</span>
          <button id="signoutBtn" class="signout-btn">
            <span>Sign out</span>
          </button>
        </div>
      </div>
    </header>

    <div class="stats-grid">
      <div class="stat-card">
        <div id="totalSessions" class="stat-value">0</div>
        <div class="stat-label">Total Sessions</div>
      </div>
      <div class="stat-card">
        <div id="totalMinutes" class="stat-value">0</div>
        <div class="stat-label">Minutes Tuned</div>
      </div>
      <div class="stat-card">
        <div id="currentStreak" class="stat-value">0</div>
        <div class="stat-label">Day Streak</div>
      </div>
      <div class="stat-card">
        <div id="frequenciesTried" class="stat-value">0</div>
        <div class="stat-label">Frequencies Used</div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="library">Library</button>
      <button class="tab" data-tab="favorites">Favorites</button>
      <button class="tab" data-tab="baths">Wellness Baths</button>
      <button class="tab" data-tab="tuner">Tuner</button>
      <button class="tab" data-tab="composer">Composer</button>
      <button class="tab" data-tab="journal">Journal</button>
      <button class="tab" data-tab="settings">Settings</button>
    </div>

    <!-- LIBRARY -->
    <section id="library" class="tab-content">
      <h2 class="section-title">Library</h2>
      <div id="tierNotice" class="tier-notice" style="display:none;"></div>
      <div class="subtle-pill">
        All <span id="libraryTotalCount">0</span> single frequencies
      </div>
      <div class="category-chips" id="libraryFilters">
        <button class="chip active" data-category="all">All</button>
        <button class="chip" data-category="healing">Healing</button>
        <button class="chip" data-category="mental">Mental</button>
        <button class="chip" data-category="spiritual">Spiritual</button>
        <button class="chip" data-category="emotional">Emotional</button>
        <button class="chip" data-category="focus">Focus</button>
        <button class="chip" data-category="sleep">Sleep</button>
      </div>
      <div id="frequenciesGrid" class="frequencies-grid"></div>
    </section>

    <!-- FAVORITES -->
    <section id="favorites" class="tab-content" style="display:none;">
      <h2 class="section-title">Favorites</h2>
      <p class="small-muted" style="text-align:center;margin-bottom:1rem;">
        Your starred tones are mirrored from the main library view.
      </p>
      <div id="favoritesGrid" class="frequencies-grid"></div>
    </section>

    <!-- BATHS -->
    <section id="baths" class="tab-content" style="display:none;">
      <h2 class="section-title">Wellness Baths</h2>
      <div class="subtle-pill">
        Guided blends for specific intentions
      </div>
      <div class="category-chips" id="bathsFilters">
        <button class="chip active" data-category="all">All</button>
        <button class="chip" data-category="healing">Healing</button>
        <button class="chip" data-category="meditation">Meditation</button>
        <button class="chip" data-category="sleep">Sleep</button>
        <button class="chip" data-category="focus">Focus</button>
      </div>
      <div id="bathsGrid" class="frequencies-grid"></div>
    </section>

    <!-- TUNER -->
    <section id="tuner" class="tab-content" style="display:none;">
      <h2 class="section-title">Tuner</h2>
      <div class="two-column">
        <div class="panel">
          <div class="panel-title">Frequency Dial</div>
          <div class="dial-container">
            <div class="dial-circle" id="dialCircle">
              <div class="dial-needle" id="dialNeedle"></div>
              <div class="dial-center"></div>
              <div class="dial-scale-label dial-label-bottom">0.01 Hz</div>
              <div class="dial-scale-label dial-label-top">20 kHz</div>
              <div class="dial-scale-label dial-label-left">Low</div>
              <div class="dial-scale-label dial-label-right">High</div>
            </div>
            <div class="dial-readout">
              <div id="tunerFrequencyValue" class="dial-readout-main">432.00</div>
              <div id="tunerFrequencyUnit" class="dial-readout-unit">Hz</div>
              <div class="small-muted" id="tunerAccuracyText">
                100% accurate
              </div>
            </div>
            <div class="dial-slider-wrap">
              <input
                id="tunerSlider"
                class="dial-slider"
                type="range"
                min="0"
                max="1000000"
                step="1"
                value="432000"
              />
            </div>
            <div class="dial-mode-toggle">
              <button class="mode-btn active" data-mode="linear" id="modeLinear">Linear</button>
              <button class="mode-btn" data-mode="log" id="modeLog">Log</button>
            </div>
            <div class="preset-grid">
              <button class="preset-btn" data-freq="40">40 Hz</button>
              <button class="preset-btn" data-freq="111">111 Hz</button>
              <button class="preset-btn" data-freq="174">174 Hz</button>
              <button class="preset-btn" data-freq="285">285 Hz</button>
              <button class="preset-btn" data-freq="396">396 Hz</button>
              <button class="preset-btn" data-freq="432">432 Hz</button>
              <button class="preset-btn" data-freq="528">528 Hz</button>
              <button class="preset-btn" data-freq="639">639 Hz</button>
            </div>
          </div>
        </div>
        <div class="panel">
          <div class="panel-title">Controls & Manual Input</div>
          <label class="settings-label">Manual frequency</label>
          <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
            <input
              id="tunerManualInput"
              class="input"
              type="text"
              placeholder="e.g. 432, 0.5 kHz, 2 kHz"
            />
            <button id="tunerManualApply" class="btn btn-outline" style="flex:0 0 auto;">
              Set
            </button>
          </div>
          <p class="small-muted">
            Values ending with "kHz" or containing "k" will auto-convert to Hz.
          </p>
          <div style="display:flex;gap:0.5rem;margin-top:0.9rem;">
            <button id="tunerPlayBtn" class="btn btn-primary">
              ‚ñ∂ Play
            </button>
            <button id="tunerStopBtn" class="btn btn-danger">
              ‚ñ† Stop
            </button>
          </div>
          <div style="margin-top:1rem;">
            <div class="panel-title">Range & Safety</div>
            <p class="small-muted">
              The tuner supports 0.01 Hz to 20000 Hz and will clamp values
              outside this range to keep your ears and speakers safe.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- COMPOSER -->
    <section id="composer" class="tab-content" style="display:none;">
      <h2 class="section-title">Composer</h2>
      <p class="small-muted" style="text-align:center;margin-bottom:1rem;">
        Stack multiple tones into a custom wellness bath.
      </p>
      <div class="two-column">
        <div class="panel">
          <div class="panel-title">Frequency Library</div>
          <div style="display:flex;gap:0.5rem;margin-bottom:0.6rem;">
            <input
              id="composerSearch"
              class="input"
              type="text"
              placeholder="Search name or Hz..."
            />
            <select id="composerFilter" class="input" style="flex:0 0 140px;">
              <option value="all">All</option>
              <option value="healing">Healing</option>
              <option value="mental">Mental</option>
              <option value="spiritual">Spiritual</option>
              <option value="emotional">Emotional</option>
              <option value="focus">Focus</option>
              <option value="sleep">Sleep</option>
            </select>
          </div>
          <div
            id="composerLibrary"
            style="max-height:360px;overflow-y:auto;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.6rem;"
          ></div>
        </div>
        <div class="panel">
          <div class="panel-title">Bath Stack</div>
          <div id="composerStack" class="composer-stack"></div>
          <div style="display:flex;gap:0.4rem;margin-top:0.7rem;">
            <button id="composerPlayBtn" class="btn btn-primary">Play Bath</button>
            <button id="composerStopBtn" class="btn btn-danger" disabled>Stop</button>
          </div>
          <div style="display:flex;gap:0.4rem;margin-top:0.5rem;">
            <button id="composerSaveBtn" class="btn btn-outline">Save Bath</button>
            <button id="composerClearBtn" class="btn btn-outline">Clear Stack</button>
          </div>
          <div style="margin-top:1rem;">
            <div class="panel-title">Saved Baths</div>
            <div id="composerSaved" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.6rem;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- JOURNAL -->
    <section id="journal" class="tab-content" style="display:none;">
      <h2 class="section-title">Journal</h2>
      <div class="two-column">
        <div class="panel">
          <div class="panel-title">New Entry</div>
          <form id="journalForm">
            <label class="settings-label">How are you feeling?</label>
            <textarea
              id="journalText"
              placeholder="Describe your session, sensations, or insights..."
            ></textarea>
            <label class="settings-label" style="margin-top:0.5rem;">Mood</label>
            <select id="journalMood" class="input">
              <option value="amazing">Amazing</option>
              <option value="great">Great</option>
              <option value="good">Good</option>
              <option value="neutral">Neutral</option>
              <option value="okay">Okay</option>
            </select>
            <button
              type="submit"
              class="btn btn-primary"
              style="margin-top:0.7rem;width:100%;"
            >
              Save Entry
            </button>
          </form>
        </div>
        <div class="panel">
          <div class="panel-title">Recent Entries</div>
          <div id="journalEntries" style="display:flex;flex-direction:column;gap:0.5rem;">
            <p class="small-muted">No entries yet. Your story begins with the first session.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="tab-content" style="display:none;">
      <h2 class="section-title">Settings</h2>
      <div class="settings-grid">
        <div class="settings-item">
          <h3>Account</h3>
          <p id="settingsAccountEmail" class="settings-label">Email: ‚Äî</p>
          <p id="settingsAccountTier" class="settings-label">Tier: Free</p>
          <p id="settingsAccountSync" class="settings-label">
            Last synced: <span id="settingsSyncTime">‚Äî</span>
          </p>
        </div>
        <div class="settings-item">
          <h3>Subscription</h3>
          <p class="small-muted">
            Weekly and lifetime tiers unlock the full catalog across web and mobile.
          </p>
          <button class="btn btn-primary" style="margin-top:0.6rem;width:100%;">
            View Subscription Options
          </button>
        </div>
        <div class="settings-item">
          <h3>Session Preferences</h3>
          <div>
            <label class="settings-label">
              Default waveform (where supported)
            </label>
            <select id="settingsWaveform" class="input" style="margin-top:0.25rem;">
              <option value="sine">Sine</option>
              <option value="triangle">Triangle</option>
              <option value="square">Square</option>
              <option value="sawtooth">Sawtooth</option>
            </select>
          </div>
          <div style="margin-top:0.5rem;">
            <label class="settings-label">
              Session reminder (local, not stored)
            </label>
            <select id="settingsReminder" class="input" style="margin-top:0.25rem;">
              <option value="none">None</option>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
        </div>
        <div class="settings-item">
          <h3>Legal</h3>
          <p class="small-muted">
            Tones by Aysa is a wellness companion and does not replace licensed
            medical or psychological care.
          </p>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---------------------------
    // Supabase client & globals
    // ---------------------------
    // Load from environment variables (injected by build system)
    const SUPABASE_URL = window.ENV?.SUPABASE_URL || "https://your-project.supabase.co";
    const SUPABASE_KEY = window.ENV?.SUPABASE_ANON_KEY || "your-anon-key-here";
    const supabaseClient =
      typeof window.supabase !== "undefined"
        ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
        : window.supabaseClient ||
          (window.supabaseClient = window.Supabase
            ? window.Supabase.createClient(SUPABASE_URL, SUPABASE_KEY)
            : null);

    let currentUser = null;
    let currentSubscriptionTier = "free";

    // Stats in memory
    const userStats = {
      totalSessions: 0,
      totalMinutes: 0,
      currentStreak: 0,
      frequenciesTried: 0,
    };

    // In-memory favorites, journal, composer data
    let favoriteFrequencyIds = [];
    let journalEntries = [];
    let composerStack = [];
    let savedBaths = [];
    let lastSyncTime = null;

    // Theme preference in memory (no localStorage)
    let isDarkMode = true;

    // ---------------------------
    // Audio player with Tone.js
    // ---------------------------
    const MIN_FREQ = 0.01;
    const MAX_FREQ = 20000; // clamp to prevent >20kHz oscillator warnings

    class SimpleFrequencyPlayer {
      constructor() {
        this.synth = null;
        this.isPlaying = false;
        this.currentTimeout = null;
      }

      async _ensureSynth() {
        if (!this.synth) {
          await Tone.start();
          this.synth = new Tone.Oscillator({
            frequency: 432,
            type: "sine",
          }).toDestination();
        }
      }

      _clampFrequency(hz) {
        const val = Number.isFinite(hz) ? hz : 432;
        return Math.min(MAX_FREQ, Math.max(MIN_FREQ, val));
      }

      async playFrequency(hz, durationSeconds = null, waveform = "sine") {
        const clamped = this._clampFrequency(hz);
        await this._ensureSynth();
        if (!this.synth) return;
        this.synth.type = waveform || "sine";
        this.synth.frequency.value = clamped;
        if (!this.isPlaying) {
          this.synth.start();
        }
        this.isPlaying = true;
        if (this.currentTimeout) {
          clearTimeout(this.currentTimeout);
          this.currentTimeout = null;
        }
        if (durationSeconds && Number.isFinite(durationSeconds)) {
          this.currentTimeout = setTimeout(() => {
            this.stop();
          }, durationSeconds * 1000);
        }
      }

      async playFrequencies(hzArray, durationSeconds = null, waveform = "sine") {
        // simple strategy: use first as dominant frequency
        if (!Array.isArray(hzArray) || hzArray.length === 0) return;
        const dominant = hzArray[0];
        await this.playFrequency(dominant, durationSeconds, waveform);
      }

      stop() {
        if (this.synth && this.isPlaying) {
          this.synth.stop();
          this.isPlaying = false;
        }
        if (this.currentTimeout) {
          clearTimeout(this.currentTimeout);
          this.currentTimeout = null;
        }
        window.dispatchEvent(new CustomEvent("healtoneplayer-stop"));
      }
    }

    const frequencyPlayer = new SimpleFrequencyPlayer();

    // ---------------------------
    // Theme toggle (no localStorage)
    // ---------------------------
    function applyTheme() {
      if (isDarkMode) {
        document.body.classList.remove("light-mode");
      } else {
        document.body.classList.add("light-mode");
      }
      const toggle = document.getElementById("themeToggle");
      if (toggle) {
        toggle.textContent = isDarkMode ? "‚òæ" : "‚òÄ";
      }
    }

    function initThemeToggle() {
      const toggle = document.getElementById("themeToggle");
      if (!toggle) return;
      applyTheme();
      toggle.addEventListener("click", () => {
        isDarkMode = !isDarkMode;
        applyTheme();
      });
    }

    // ---------------------------
    // Sample frequency catalog
    // ---------------------------
    // Initialize with empty array - will be populated from HealToneCatalog on load
    let baseFrequencies = [];
    let baseBaths = [];
    
    // Wait for catalog to load with timeout
    let catalogLoadAttempts = 0;
    const maxAttempts = 50; // 5 second timeout (50 * 100ms)
    
    function ensureCatalogLoaded() {
      return new Promise((resolve) => {
        const checkCatalog = () => {
          if (window.HealToneCatalog && window.HealToneCatalog.frequencyCatalog) {
            console.log('‚úì HealToneCatalog found');
            resolve(true);
          } else if (catalogLoadAttempts >= maxAttempts) {
            console.warn('‚ö† Catalog loading timeout after 5 seconds, using fallback');
            resolve(false);
          } else {
            catalogLoadAttempts++;
            setTimeout(checkCatalog, 100);
          }
        };
        checkCatalog();
      });
    }
    
    function initializeFrequencyData() {
      // Load from HealToneCatalog if available
      if (window.HealToneCatalog && window.HealToneCatalog.frequencyCatalog) {
        // Keep all frequencies that aren't baths - include single, binaural, and other types
        baseFrequencies = window.HealToneCatalog.frequencyCatalog.filter(freq => freq.type !== 'bath');
        baseBaths = window.HealToneCatalog.frequencyCatalog.filter(freq => freq.type === 'bath');
        console.log(`‚úì Loaded ${baseFrequencies.length} frequencies and ${baseBaths.length} baths from HealToneCatalog`);
        console.log('Sample frequencies:', baseFrequencies.slice(0, 3).map(f => `${f.name} (${f.hz}Hz)`));
      } else if (window.frequencyCatalog) {
        baseFrequencies = window.frequencyCatalog.filter(freq => freq.type !== 'bath');
        baseBaths = window.frequencyCatalog.filter(freq => freq.type === 'bath');
        console.log(`‚úì Loaded ${baseFrequencies.length} frequencies and ${baseBaths.length} baths from window.frequencyCatalog`);
      } else {
        // Fallback to sample data if catalog not available
        console.warn('‚ö†Ô∏è Using fallback frequency list - HealToneCatalog not found');
        baseFrequencies = [
          { id: "f-432", name: "Harmonic 432", hz: 432, category: "spiritual", tier_access: "free", usage: "Heart-centered alignment and balanced presence" },
          { id: "f-528", name: "DNA Repair 528", hz: 528, category: "healing", tier_access: "free", usage: "Deep restoration and rejuvenation" },
          { id: "f-40", name: "Gamma 40", hz: 40, category: "focus", tier_access: "free", usage: "Enhanced focus and cognitive clarity" },
          { id: "f-111", name: "Divine 111", hz: 111, category: "spiritual", tier_access: "free", usage: "Meditative trance and spiritual opening" },
          { id: "f-174", name: "Pain Relief 174", hz: 174, category: "healing", tier_access: "free", usage: "Calming pain and tension relief" },
          { id: "f-285", name: "Tissue Healing 285", hz: 285, category: "healing", tier_access: "free", usage: "Physical regeneration and cellular repair" },
          { id: "f-396", name: "Release Fear 396", hz: 396, category: "emotional", tier_access: "free", usage: "Releasing deep fear and guilt" },
          { id: "f-639", name: "Harmony 639", hz: 639, category: "emotional", tier_access: "free", usage: "Relationships, connection, and empathy" },
        ];
        baseBaths = [
          {
            id: "bath-core-healing",
            name: "Core Healing",
            hz: [174, 285, 528],
            category: "healing",
            tier_access: "free",
            durationMin: 15,
            usage: "Gentle tissue regeneration and deep energetic cleansing.",
          },
          {
            id: "bath-deep-sleep",
            name: "Deep Sleep Cocoon",
            hz: [40, 111],
            category: "sleep",
            tier_access: "free",
            durationMin: 30,
            usage: "Helps the brain settle into deep restorative sleep states.",
          },
        ];
        console.warn('‚ö†Ô∏è Using fallback sample frequencies and baths - catalog not loaded');
      }
    }

    function getAccessibleFrequencies() {
      if (!Array.isArray(baseFrequencies)) {
        return [];
      }
      
      if (currentSubscriptionTier === 'weekly' || currentSubscriptionTier === 'lifetime') {
        return baseFrequencies;
      } else {
        return baseFrequencies.filter(f => f.tier_access === 'free' || f.pack_ids?.includes('core_foundations'));
      }
    }

    // ---------------------------
    // Stats UI
    // ---------------------------
    function updateStatsUI() {
      const s = userStats;
      const el = (id) => document.getElementById(id);
      if (el("totalSessions")) el("totalSessions").textContent = s.totalSessions;
      if (el("totalMinutes")) el("totalMinutes").textContent = s.totalMinutes;
      if (el("currentStreak")) el("currentStreak").textContent = s.currentStreak;
      if (el("frequenciesTried")) el("frequenciesTried").textContent = s.frequenciesTried;
    }

    async function handlePlayerStop() {
      // Increment sessions; minutes are approximate, updated elsewhere if needed
      userStats.totalSessions += 1;
      updateStatsUI();
      if (!supabaseClient || !currentUser) return;

      try {
        const payload = {
          user_id: currentUser.id,
          total_sessions: userStats.totalSessions,
          total_minutes: userStats.totalMinutes,
          current_streak: userStats.currentStreak,
          frequencies_tried: userStats.frequenciesTried,
          last_session: new Date().toISOString(),
        };

        // Plain upsert (no onConflict) to avoid 400s when constraint is missing
        const { error } = await supabaseClient.from("user_stats").upsert(payload);
        if (error) {
          const code = String(error.code || "");
          if (code === "42P01" || error.message?.includes("relation")) {
            console.warn("user_stats table not ready yet; skipping stats sync");
          } else {
            console.warn("Stats sync error:", error.message);
          }
        }
      } catch (err) {
        console.warn("Stats sync exception; ignoring to prevent crash.", err);
      }
    }

    window.addEventListener("healtoneplayer-stop", handlePlayerStop);

    // ---------------------------
    // Auth & session
    // ---------------------------
    async function hydrateUserSession() {
      if (!supabaseClient) {
        console.warn("‚ö† Supabase client not available; app will run offline.");
        return;
      }
      try {
        console.log('üîç Fetching session...');
        const { data, error } = await supabaseClient.auth.getSession();
        
        if (error) {
          console.warn("‚ö† Session fetch error:", error.message);
          currentUser = null;
          currentSubscriptionTier = "free";
          updateAccountUI();
          return;
        }
        
        if (!data || !data.session) {
          console.log('‚Ñπ No active session (guest mode)');
          currentUser = null;
          currentSubscriptionTier = "free";
          updateAccountUI();
          return;
        }
        
        console.log('‚úì Session found for:', data.session.user.email);
        currentUser = data.session.user;
        const displayName =
          currentUser.user_metadata?.full_name ||
          currentUser.user_metadata?.fullname ||
          currentUser.email ||
          "Member";
        const userNameEl = document.getElementById("userName");
        if (userNameEl) {
          userNameEl.textContent = displayName;
          console.log('‚úì Updated user name:', displayName);
        }

        // Fetch subscription tier from profiles table
        const { data: profile, error: pError } = await supabaseClient
          .from("profiles")
          .select("subscription_tier")
          .eq("id", currentUser.id)
          .maybeSingle();
          
        if (pError) {
          console.warn("‚ö† Profile fetch error:", pError.message);
          currentSubscriptionTier = "free";
        } else if (profile && profile.subscription_tier) {
          currentSubscriptionTier = profile.subscription_tier;
          console.log('‚úì Loaded tier:', currentSubscriptionTier);
        } else {
          console.log('‚Ñπ No profile tier found, using free');
          currentSubscriptionTier = "free";
        }
        
        lastSyncTime = new Date();
        updateAccountUI();
        updateTierNotice();
        console.log('‚úì User session hydrated');
      } catch (err) {
        console.error("‚ùå hydrateUserSession error:", err);
        currentUser = null;
        currentSubscriptionTier = "free";
        updateAccountUI();
      }
    }

    async function signOut() {
      try {
        frequencyPlayer.stop();
        // Only call auth.signOut if we have an actual authenticated session
        if (supabaseClient && currentUser) {
          await supabaseClient.auth.signOut();
        }
      } catch (err) {
        console.warn("signOut error:", err);
      } finally {
        currentUser = null;
        currentSubscriptionTier = "free";
        updateAccountUI();
        updateTierNotice();
        // Redirect to login page
        window.location.href = 'login.html';
      }
    }

    // ---------------------------
    // Account / tier UI
    // ---------------------------
    function formatTierLabel(tier) {
      if (!tier) return "Free";
      const v = String(tier).toLowerCase();
      if (v === "lifetime") return "Lifetime";
      if (v === "weekly") return "Weekly";
      return "Free";
    }

    function updateTierNotice() {
      const el = document.getElementById("tierNotice");
      if (!el) return;
      const label = formatTierLabel(currentSubscriptionTier);
      if (label === "Free") {
        el.style.display = "block";
        el.innerHTML =
          "<strong>Free Tier Preview</strong> ¬∑ You can explore featured healing frequencies. Upgrade later for the full library.";
      } else {
        el.style.display = "block";
        el.innerHTML =
          "<strong>" +
          label +
          " Tier</strong> ¬∑ Full library access is unlocked on all devices linked to your account.";
      }
    }

    function updateAccountUI() {
      const emailEl = document.getElementById("settingsAccountEmail");
      const tierEl = document.getElementById("settingsAccountTier");
      const syncEl = document.getElementById("settingsSyncTime");
      const signoutBtn = document.getElementById("signoutBtn");
      
      if (emailEl) {
        emailEl.textContent = "Email: " + (currentUser?.email || "Guest");
      }
      if (tierEl) {
        tierEl.textContent = "Tier: " + formatTierLabel(currentSubscriptionTier);
      }
      if (syncEl) {
        syncEl.textContent = lastSyncTime
          ? lastSyncTime.toLocaleTimeString()
          : "Not synced";
      }
      
      // Show/hide sign out button based on authentication state
      if (signoutBtn) {
        if (currentUser) {
          signoutBtn.classList.add('visible');
        } else {
          signoutBtn.classList.remove('visible');
        }
      }
    }

    // ---------------------------
    // Library rendering
    // ---------------------------
    function renderLibrary(category = "all") {
      const grid = document.getElementById("frequenciesGrid");
      if (!grid) return;
      const all = getAccessibleFrequencies();
      let filtered =
        category === "all"
          ? all
          : all.filter((f) => String(f.category) === String(category));
      document.getElementById("libraryTotalCount").textContent = String(
        filtered.length
      );
      if (filtered.length === 0) {
        grid.innerHTML =
          '<p class="small-muted" style="grid-column:1/-1;text-align:center;">No frequencies in this category yet.</p>';
        return;
      }
      grid.innerHTML = "";
      const favSet = new Set(favoriteFrequencyIds);
      filtered.forEach((freq) => {
        const card = document.createElement("div");
        card.className =
          "frequency-card" + (favSet.has(freq.id) ? " is-favorite" : "");
        const isFav = favSet.has(freq.id);
        const heart = isFav ? "‚ô•" : "‚ô°";
        
        // Handle hz as array - get primary frequency for display
        const primaryHz = Array.isArray(freq.hz) ? freq.hz[0] : freq.hz;
        const hzDisplay = typeof primaryHz === 'number' ? primaryHz.toFixed(2) : primaryHz;
        
        card.innerHTML = `
          <div class="frequency-header">
            <div>
              <div class="frequency-name">${freq.name || "Untitled"}</div>
              <div class="frequency-tag">${freq.category || "Healing"}</div>
            </div>
          </div>
          <div class="frequency-main">
            <div class="frequency-main-value">${hzDisplay}</div>
            <div class="frequency-main-unit">Hz</div>
            <div class="frequency-usage">${freq.usage || ""}</div>
          </div>
          <div class="frequency-actions">
            <button class="btn btn-primary play-btn" data-hz="${primaryHz}" data-id="${
          freq.id
        }">Play</button>
            <button class="btn btn-danger stop-btn">Stop</button>
          </div>
        `;
        // Add favorite button to card
        const favBtn = document.createElement('button');
        favBtn.className = 'favorite-btn';
        favBtn.dataset.favId = freq.id; // or bath.id
        favBtn.innerHTML = 'ü§ç';
        favBtn.onclick = (e) => {
          e.stopPropagation();
          toggleFavorite(freq.id, 'frequency'); // or 'bath'
        };
        card.appendChild(favBtn);
        const playBtn = card.querySelector(".play-btn");
        const stopBtn = card.querySelector(".stop-btn");
        playBtn.addEventListener("click", async () => {
          const hz = parseFloat(playBtn.getAttribute("data-hz") || "432");
          userStats.frequenciesTried += 1;
          updateStatsUI();
          const waveform =
            document.getElementById("settingsWaveform")?.value || "sine";
          try {
            await frequencyPlayer.playFrequency(hz, null, waveform);
          } catch (err) {
            console.warn("playFrequency error:", err);
          }
        });
        stopBtn.addEventListener("click", () => {
          frequencyPlayer.stop();
        });
        grid.appendChild(card);
      });
    }

    function toggleFavorite(id) {
      const idx = favoriteFrequencyIds.indexOf(id);
      if (idx >= 0) {
        favoriteFrequencyIds.splice(idx, 1);
      } else {
        favoriteFrequencyIds.push(id);
      }
      renderLibrary(currentLibraryCategory);
      renderFavoritesTab();
    }

    function renderFavoritesTab() {
      const grid = document.getElementById("favoritesGrid");
      if (!grid) return;
      const all = getAccessibleFrequencies();
      const favSet = new Set(favoriteFrequencyIds);
      const favorites = all.filter((f) => favSet.has(f.id));
      if (favorites.length === 0) {
        grid.innerHTML =
          '<p class="small-muted" style="grid-column:1/-1;text-align:center;">No favorites yet. Tap the heart icon in the library to star a tone.</p>';
        return;
      }
      grid.innerHTML = "";
      favorites.forEach((freq) => {
        const card = document.createElement("div");
        card.className = "frequency-card is-favorite";
        card.innerHTML = `
          <div class="frequency-header">
            <div>
              <div class="frequency-name">${freq.name || "Untitled"}</div>
              <div class="frequency-tag">Favorite ¬∑ ${freq.category || ""}</div>
            </div>
            <button class="favorite-btn active" data-id="${freq.id}">‚ô•</button>
          </div>
          <div class="frequency-main">
            <div class="frequency-main-value">${freq.hz.toFixed(2)}</div>
            <div class="frequency-main-unit">Hz</div>
            <div class="frequency-usage">${freq.usage || ""}</div>
          </div>
          <div class="frequency-actions">
            <button class="btn btn-primary play-btn" data-hz="${freq.hz}">Play</button>
            <button class="btn btn-danger stop-btn">Stop</button>
          </div>
        `;
        const playBtn = card.querySelector(".play-btn");
        const stopBtn = card.querySelector(".stop-btn");
        const favBtn = card.querySelector(".favorite-btn");
        playBtn.addEventListener("click", async () => {
          const hz = parseFloat(playBtn.getAttribute("data-hz") || "432");
          const waveform =
            document.getElementById("settingsWaveform")?.value || "sine";
          try {
            await frequencyPlayer.playFrequency(hz, null, waveform);
          } catch (err) {
            console.warn("playFrequency error:", err);
          }
        });
        stopBtn.addEventListener("click", () => frequencyPlayer.stop());
        favBtn.addEventListener("click", () => toggleFavorite(freq.id));
        grid.appendChild(card);
      });
    }

    let currentLibraryCategory = "all";

    function initLibraryFilters() {
      const container = document.getElementById("libraryFilters");
      if (!container) return;
      container.querySelectorAll(".chip").forEach((chip) => {
        chip.addEventListener("click", () => {
          container.querySelectorAll(".chip").forEach((c) =>
            c.classList.remove("active")
          );
          chip.classList.add("active");
          currentLibraryCategory = chip.getAttribute("data-category") || "all";
          renderLibrary(currentLibraryCategory);
        });
      });
    }

    // ---------------------------
    // Baths rendering
    // ---------------------------
    // This will be populated from baseBaths during initialization
    const defaultBaths = [];

    function getAccessibleBaths() {
      // Filter baths based on user's subscription tier
      if (!Array.isArray(baseBaths)) {
        return [];
      }
      
      const tierHierarchy = {
        'free': 0,
        'weekly': 1,
        'lifetime': 2
      };
      
      const userTierLevel = tierHierarchy[currentSubscriptionTier] || 0;
      const tierAccessMap = {
        'free': 0,
        'weekly': 1,
        'lifetime': 2
      };
      
      return baseBaths.filter(bath => {
        if (!bath.tier_access) {
          // No tier restriction - available to all
          return true;
        }
        
        const requiredTierLevel = tierAccessMap[bath.tier_access] || 0;
        // User can access if their tier level >= required tier level
        return userTierLevel >= requiredTierLevel;
      });
    }

    function renderBaths(category = "all") {
      const grid = document.getElementById("bathsGrid");
      if (!grid) return;
      const allBaths = getAccessibleBaths();
      const baths =
        category === "all"
          ? allBaths
          : allBaths.filter((b) => b.category === category);
      if (baths.length === 0) {
        grid.innerHTML =
          '<p class="small-muted" style="grid-column:1/-1;text-align:center;">No baths in this category yet.</p>';
        return;
      }
      grid.innerHTML = "";
      baths.forEach((bath) => {
        const card = document.createElement("div");
        card.className = "frequency-card";
        
        // Get hz array - handle both array and potential object structures
        const hzArray = Array.isArray(bath.hz) ? bath.hz : (bath.frequencies ? bath.frequencies.map(f => f.hz) : []);
        const durationMin = bath.duration_seconds ? Math.round(bath.duration_seconds / 60) : (bath.durationMin || 15);
        
        card.innerHTML = `
          <div class="frequency-header">
            <div>
              <div class="frequency-name">${bath.name}</div>
              <div class="frequency-tag">${bath.category}</div>
            </div>
          </div>
          <div class="frequency-main">
            <div class="frequency-main-value">
              ${hzArray.map((h) => (typeof h === 'number' ? h.toFixed(0) : h)).join(" ¬∑ ")}
            </div>
            <div class="frequency-main-unit">
              Hz ¬∑ ${durationMin} min
            </div>
            <div class="frequency-usage">${bath.usage || 'Wellness bath'}</div>
          </div>
          <div class="frequency-actions">
            <button class="btn btn-primary play-bath">Play Bath</button>
            <button class="btn btn-danger stop-bath">Stop</button>
          </div>
        `;
        // Add favorite button to card
        const favBtn = document.createElement('button');
        favBtn.className = 'favorite-btn';
        favBtn.dataset.favId = bath.id; // or bath.id
        favBtn.innerHTML = 'ü§ç';
        favBtn.onclick = (e) => {
          e.stopPropagation();
          toggleFavorite(bath.id, 'bath'); // or 'bath'
        };
        card.appendChild(favBtn);
        const playBtn = card.querySelector(".play-bath");
        const stopBtn = card.querySelector(".stop-bath");
        playBtn.addEventListener("click", async () => {
          const waveform =
            document.getElementById("settingsWaveform")?.value || "sine";
          const duration = durationMin * 60;
          userStats.frequenciesTried += hzArray.length;
          updateStatsUI();
          try {
            await frequencyPlayer.playFrequencies(hzArray, duration, waveform);
          } catch (err) {
            console.warn("playFrequencies error:", err);
          }
        });
        stopBtn.addEventListener("click", () => frequencyPlayer.stop());
        grid.appendChild(card);
      });
    }

    function initBathFilters() {
      const container = document.getElementById("bathsFilters");
      if (!container) return;
      container.querySelectorAll(".chip").forEach((chip) => {
        chip.addEventListener("click", () => {
          container.querySelectorAll(".chip").forEach((c) =>
            c.classList.remove("active")
          );
          chip.classList.add("active");
          const category = chip.getAttribute("data-category") || "all";
          renderBaths(category);
        });
      });
    }

    // ---------------------------
    // Tuner implementation
    // ---------------------------
    class FrequencyDial {
      constructor() {
        this.slider = document.getElementById("tunerSlider");
        this.valueEl = document.getElementById("tunerFrequencyValue");
        this.unitEl = document.getElementById("tunerFrequencyUnit");
        this.accuracyEl = document.getElementById("tunerAccuracyText");
        this.needle = document.getElementById("dialNeedle");
        this.mode = "linear";
        this.MIN = MIN_FREQ;
        this.MAX = MAX_FREQ;
        this._wire();
        this.setFrequency(432);
      }

      _wire() {
        if (this.slider) {
          this.slider.addEventListener("input", (e) =>
            this._updateFromSlider(e)
          );
        }
        document
          .querySelectorAll(".mode-btn")
          .forEach((btn) =>
            btn.addEventListener("click", () => this.setMode(btn.dataset.mode))
          );
        document.querySelectorAll(".preset-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const hz = parseFloat(btn.dataset.freq || "432");
            this.setFrequency(hz);
          });
        });
      }

      _updateFromSlider(e) {
        const raw = parseFloat(e.target.value || "0");
        let hz;
        if (this.mode === "log") {
          const minLog = Math.log10(this.MIN);
          const maxLog = Math.log10(this.MAX);
          const t = raw / 1000000;
          const valLog = minLog + t * (maxLog - minLog);
          hz = Math.pow(10, valLog);
        } else {
          const t = raw / 1000000;
          hz = this.MIN + t * (this.MAX - this.MIN);
        }
        this._updateDisplay(hz);
      }

      setMode(mode) {
        this.mode = mode === "log" ? "log" : "linear";
        document.querySelectorAll(".mode-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.mode === this.mode);
        });
        this.setFrequency(this.getCurrentFrequency());
      }

      getCurrentFrequency() {
        const val = parseFloat(this.valueEl.textContent || "432");
        const unit = this.unitEl.textContent || "Hz";
        if (unit.toLowerCase().includes("khz")) {
          return val * 1000;
        }
        return val;
      }

      setFrequency(hz) {
        const clamped = Math.min(this.MAX, Math.max(this.MIN, hz));
        this._updateDisplay(clamped);
        let sliderValue;
        if (this.mode === "log") {
          const minLog = Math.log10(this.MIN);
          const maxLog = Math.log10(this.MAX);
          const valLog = Math.log10(clamped);
          const t = (valLog - minLog) / (maxLog - minLog);
          sliderValue = t * 1000000;
        } else {
          const t = (clamped - this.MIN) / (this.MAX - this.MIN);
          sliderValue = t * 1000000;
        }
        if (this.slider) {
          this.slider.value = String(Math.round(sliderValue));
        }
      }

      _updateDisplay(hz) {
        const clamped = Math.min(this.MAX, Math.max(this.MIN, hz));
        let displayValue;
        let unit;
        if (clamped >= 1000) {
          displayValue = (clamped / 1000).toFixed(3);
          unit = "kHz";
        } else {
          displayValue = clamped.toFixed(2);
          unit = "Hz";
        }
        this.valueEl.textContent = displayValue;
        this.unitEl.textContent = unit;
        if (this.accuracyEl) {
          this.accuracyEl.textContent = "100% accurate";
        }
        if (this.needle) {
          const minLog = Math.log10(this.MIN);
          const maxLog = Math.log10(this.MAX);
          const valLog = Math.log10(clamped);
          const t = (valLog - minLog) / (maxLog - minLog);
          const angle = t * 270 - 135;
          this.needle.style.transform = "rotate(" + angle.toFixed(2) + "deg)";
        }
        document.querySelectorAll(".preset-btn").forEach((btn) => {
          const presetHz = parseFloat(btn.dataset.freq || "0");
          btn.classList.toggle(
            "active",
            Math.abs(presetHz - clamped) < 0.5
          );
        });
      }
    }

    let frequencyDial = null;

    function initTunerTab() {
      if (!frequencyDial) {
        frequencyDial = new FrequencyDial();
      }
      const manualInput = document.getElementById("tunerManualInput");
      const manualApply = document.getElementById("tunerManualApply");
      const playBtn = document.getElementById("tunerPlayBtn");
      const stopBtn = document.getElementById("tunerStopBtn");

      if (manualApply && manualInput) {
        manualApply.addEventListener("click", () => {
          const raw = manualInput.value.trim();
          if (!raw) return;
          let value = parseFloat(raw);
          let isKHz = false;
          if (raw.toLowerCase().includes("khz") || raw.toLowerCase().includes("k")) {
            isKHz = true;
          }
          if (!Number.isFinite(value)) return;
          let hz = isKHz ? value * 1000 : value;
          hz = Math.min(MAX_FREQ, Math.max(MIN_FREQ, hz));
          frequencyDial.setFrequency(hz);
        });
      }

      if (playBtn) {
        playBtn.addEventListener("click", async () => {
          const hz = frequencyDial.getCurrentFrequency();
          const waveform =
            document.getElementById("settingsWaveform")?.value || "sine";
          userStats.frequenciesTried += 1;
          updateStatsUI();
          try {
            await frequencyPlayer.playFrequency(hz, null, waveform);
          } catch (err) {
            console.warn("tuner play error:", err);
          }
        });
      }
      if (stopBtn) {
        stopBtn.addEventListener("click", () => frequencyPlayer.stop());
      }

      // Backward compatibility for older handlers
      window.initTuner = initTunerTab;
    }

    // ---------------------------
    // Composer
    // ---------------------------
    function renderComposerLibrary() {
      const container = document.getElementById("composerLibrary");
      if (!container) return;
      const search = (document.getElementById("composerSearch").value || "")
        .toLowerCase()
        .trim();
      const filter =
        document.getElementById("composerFilter").value || "all";
      const all = getAccessibleFrequencies();
      const filtered = all.filter((f) => {
        const byFilter =
          filter === "all" || String(f.category) === String(filter);
        const bySearch =
          !search ||
          (f.name || "").toLowerCase().includes(search) ||
          String(f.hz).includes(search);
        return byFilter && bySearch;
      });
      if (filtered.length === 0) {
        container.innerHTML =
          '<p class="small-muted" style="grid-column:1/-1;text-align:center;">No matching frequencies.</p>';
        return;
      }
      container.innerHTML = "";
      filtered.forEach((freq) => {
        const item = document.createElement("div");
        item.className = "journal-entry";
        item.style.cursor = "pointer";
        item.innerHTML = `
          <div class="journal-entry-header">
            <span>${freq.name}</span>
            <span class="badge">${freq.hz.toFixed(2)} Hz</span>
          </div>
          <div class="tag">${freq.category}</div>
        `;
        item.addEventListener("click", () => {
          addComposerLayer(freq);
        });
        container.appendChild(item);
      });
    }

    function addComposerLayer(freq) {
      if (!composerStack.find((f) => f.id === freq.id)) {
        composerStack.push(freq);
        renderComposerStack();
      }
    }

    function renderComposerStack() {
      const container = document.getElementById("composerStack");
      if (!container) return;
      if (composerStack.length === 0) {
        container.innerHTML =
          '<p class="small-muted">No layers yet. Click tones from the library to stack them.</p>';
        return;
      }
      container.innerHTML = "";
      composerStack.forEach((freq, idx) => {
        const row = document.createElement("div");
        row.className = "composer-layer";
        row.innerHTML = `
          <div>
            <div>${freq.name}</div>
            <div class="tag">${freq.hz.toFixed(2)} Hz ¬∑ ${freq.category}</div>
          </div>
          <button class="btn btn-outline" style="flex:0 0 auto;">Remove</button>
        `;
        row.querySelector("button").addEventListener("click", () => {
          composerStack.splice(idx, 1);
          renderComposerStack();
        });
        container.appendChild(row);
      });
    }

    function renderSavedBaths() {
      const container = document.getElementById("composerSaved");
      if (!container) return;
      if (savedBaths.length === 0) {
        container.innerHTML =
          '<p class="small-muted" style="grid-column:1/-1;">No saved baths yet.</p>';
        return;
      }
      container.innerHTML = "";
      savedBaths.forEach((bath, index) => {
        const card = document.createElement("div");
        card.className = "journal-entry";
        card.innerHTML = `
          <div class="journal-entry-header">
            <span>${bath.name}</span>
            <span class="badge">${bath.frequencies.length} layers</span>
          </div>
          <div class="tag">${bath.frequencies.map((f) => f.hz.toFixed(0)).join(" ¬∑ ")} Hz</div>
          <div style="display:flex;gap:0.4rem;margin-top:0.4rem;">
            <button class="btn btn-primary" style="flex:1;">Play</button>
            <button class="btn btn-outline" style="flex:1;">Delete</button>
          </div>
        `;
        const [playBtn, deleteBtn] = card.querySelectorAll("button");
        playBtn.addEventListener("click", async () => {
          if (!bath.frequencies || bath.frequencies.length === 0) return;
          const hzArray = bath.frequencies.map((f) => f.hz);
          const waveform =
            document.getElementById("settingsWaveform")?.value || "sine";
          try {
            await frequencyPlayer.playFrequencies(hzArray, null, waveform);
          } catch (err) {
            console.warn("saved bath play error:", err);
          }
        });
        deleteBtn.addEventListener("click", () => {
          savedBaths.splice(index, 1);
          renderSavedBaths();
        });
        container.appendChild(card);
      });
    }

    function initComposer() {
      const search = document.getElementById("composerSearch");
      const filter = document.getElementById("composerFilter");
      const playBtn = document.getElementById("composerPlayBtn");
      const stopBtn = document.getElementById("composerStopBtn");
      const saveBtn = document.getElementById("composerSaveBtn");
      const clearBtn = document.getElementById("composerClearBtn");

      if (search) {
        search.addEventListener("input", renderComposerLibrary);
      }
      if (filter) {
        filter.addEventListener("change", renderComposerLibrary);
      }
      if (playBtn) {
        playBtn.addEventListener("click", async () => {
          if (composerStack.length === 0) return;
          const hzArray = composerStack.map((f) => f.hz);
          const waveform =
            document.getElementById("settingsWaveform")?.value || "sine";
          stopBtn.disabled = false;
          try {
            await frequencyPlayer.playFrequencies(hzArray, null, waveform);
          } catch (err) {
            console.warn("composer play error:", err);
          }
        });
      }
      if (stopBtn) {
        stopBtn.addEventListener("click", () => {
          frequencyPlayer.stop();
          stopBtn.disabled = true;
        });
      }
      if (saveBtn) {
        saveBtn.addEventListener("click", () => {
          if (composerStack.length === 0) return;
          const name = prompt("Name your bath:");
          if (!name) return;
          savedBaths.push({
            name,
            frequencies: composerStack.slice().map((f) => ({
              id: f.id,
              name: f.name,
              hz: f.hz,
            })),
          });
          renderSavedBaths();
        });
      }
      if (clearBtn) {
        clearBtn.addEventListener("click", () => {
          composerStack = [];
          renderComposerStack();
        });
      }

      renderComposerLibrary();
      renderComposerStack();
      renderSavedBaths();
    }

    // ---------------------------
    // Journal
    // ---------------------------
    function renderJournalEntries() {
      const container = document.getElementById("journalEntries");
      if (!container) return;
      if (journalEntries.length === 0) {
        container.innerHTML =
          '<p class="small-muted">No entries yet. Your story begins with the first session.</p>';
        return;
      }
      container.innerHTML = "";
      [...journalEntries]
        .slice()
        .reverse()
        .forEach((entry) => {
          const row = document.createElement("div");
          row.className = "journal-entry";
          row.innerHTML = `
            <div class="journal-entry-header">
              <span>${entry.date}</span>
              <span class="badge badge-success">${entry.mood}</span>
            </div>
            <div>${entry.text}</div>
          `;
          container.appendChild(row);
        });
    }

    function initJournal() {
      const form = document.getElementById("journalForm");
      const textEl = document.getElementById("journalText");
      const moodEl = document.getElementById("journalMood");
      if (!form) return;
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const text = (textEl.value || "").trim();
        const mood = moodEl.value || "good";
        if (!text) return;
        journalEntries.push({
          text,
          mood,
          date: new Date().toLocaleDateString(),
        });
        textEl.value = "";
        renderJournalEntries();
      });
      renderJournalEntries();
    }

    // ---------------------------
    // Tabs
    // ---------------------------
    function showTab(tabId) {
      document
        .querySelectorAll(".tab-content")
        .forEach((el) => (el.style.display = el.id === tabId ? "block" : "none"));
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.classList.toggle("active", tab.dataset.tab === tabId);
      });
      if (tabId === "library") renderLibrary(currentLibraryCategory);
      if (tabId === "favorites") renderFavoritesTab();
      if (tabId === "baths") renderBaths("all");
      if (tabId === "tuner") initTunerTab();
      if (tabId === "composer") initComposer();
      if (tabId === "journal") initJournal();
      if (tabId === "settings") updateAccountUI();
    }

    function initTabs() {
      document.querySelectorAll(".tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          const tabId = tab.dataset.tab;
          showTab(tabId);
        });
      });
    }

    // ---------------------------
    // Boot
    // ---------------------------
    async function runApp() {
      try {
        // Step 1: Ensure all data scripts are loaded
        await ensureCatalogLoaded();
        initializeFrequencyData();
        
        // Step 2: Initialize UI
        initThemeToggle();
        initTabs();
        initLibraryFilters();
        initBathFilters();
        
        // Step 3: Render initial content
        renderLibrary("all");
        renderBaths("all");
        updateStatsUI();
        
        // Step 4: Load user session
        await hydrateUserSession();
        
        // Step 5: Attach event listeners
        const signoutBtn = document.getElementById("signoutBtn");
        if (signoutBtn) {
          signoutBtn.addEventListener("click", (e) => {
            e.preventDefault();
            signOut();
          });
        }
        
        console.log('‚úì App initialized successfully');
      } catch (err) {
        console.error('App initialization error:', err);
      }
    }

    document.addEventListener("DOMContentLoaded", runApp);
  </script>
</body>
</html>